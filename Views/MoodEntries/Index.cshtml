@model IEnumerable<WellnessTracker.Models.MoodEntry>

@{
    ViewData["Title"] = "Index";
}
@{
    int currentOffset = ViewBag.WeekOffset ?? 0;
    DateTime startOfWeek = ViewBag.StartOfWeek ?? DateTime.Today;
    DateTime endOfWeek = ViewBag.EndOfWeek ?? DateTime.Today;
}

<h1>Mood Entries</h1>

<h3>Mood Trend</h3>
<div class="d-flex align-items-center mb-2">
    <a class="btn btn-secondary me-2" href="@Url.Action("Index", new { weekOffset = currentOffset - 1 })">← Previous Week</a>

    @if (endOfWeek < DateTime.Today)
    {
        <a class="btn btn-secondary me-2" href="@Url.Action("Index", new { weekOffset = currentOffset + 1 })">Next Week →</a>
    }
    else
    {
        <button class="btn btn-secondary me-2" disabled>Next Week →</button>
    }

    <span id="weekLabel" class="fw-bold">Week of @startOfWeek.ToString("MM/dd/yyyy") to @endOfWeek.ToString("MM/dd/yyyy")</span>
</div>

<canvas id="moodChart" height="100"></canvas>
<div class="mood-legend mb-3">
    <h5>Mood Color Legend</h5>
    <ul style="list-style: none; padding-left: 0;">
        <li><span style="color: blue; font-weight: bold;">&#9632;</span> 9-10: Great</li>
        <li><span style="color: green; font-weight: bold;">&#9632;</span> 7-8: Good</li>
        <li><span style="color: goldenrod; font-weight: bold;">&#9632;</span> 5-6: Okay</li>
        <li><span style="color: orange; font-weight: bold;">&#9632;</span> 3-4: Bad</li>
        <li><span style="color: red; font-weight: bold;">&#9632;</span> 1-2: Worst</li>
    </ul>
</div>
<hr />

<p>
    <a asp-action="Create">Create New</a>
</p>

<table class="table">
    <thead>
        <tr>
            <th>@Html.DisplayNameFor(model => model.Date)</th>
            <th>@Html.DisplayNameFor(model => model.MoodRating)</th>
            <th>@Html.DisplayNameFor(model => model.Notes)</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@Html.DisplayFor(modelItem => item.Date)</td>
                <td>@Html.DisplayFor(modelItem => item.MoodRating)</td>
                <td>@Html.DisplayFor(modelItem => item.Notes)</td>
                <td>
                    <a asp-action="Edit" asp-route-id="@item.Id">Edit</a> |
                    <a asp-action="Details" asp-route-id="@item.Id">Details</a> |
                    <a asp-action="Delete" asp-route-id="@item.Id">Delete</a>
                </td>
            </tr>
        }
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<canvas id="moodChart" width="400" height="200"></canvas>
<script>
    let weekOffset = @(ViewBag.WeekOffset ?? 0);
    let chart;

    function loadMoodChart() {
        console.log("Loading chart for weekOffset:", weekOffset);

        fetch(`/MoodEntries/MoodGraphData?weekOffset=${weekOffset}`)
            .then(r => r.json())
            .then(data => {
                console.log("Received data:", data);

                const labels = data.map(x => x.date);
                const values = data.map(x => x.moodRating);
                const colors = values.map(v => v >= 9 ? "blue" : v >= 7 ? "green" : v >= 5 ? "goldenrod" : v >= 3 ? "orange" : "red");

                if (chart) chart.destroy();

                const ctx = document.getElementById('moodChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Mood Rating',
                            data: values,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10
                            }
                        }
                    }
                });
            })
            .catch(err => console.error("Fetch error:", err));
    }

    loadMoodChart();
</script>
